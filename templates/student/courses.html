{% extends "base.html" %}

{% block title %}My Courses - Student{% endblock %}

{% block content %}
<div class="d-flex justify-between align-center mb-4">
    <h1 class="mb-0">My Courses</h1>
    <a href="{{ url_for('student.enroll') }}" class="btn btn-primary">ğŸ“š Enroll in New Course</a>
</div>

{% if enrollments %}
<div class="grid grid-2 gap-3">
    {% for enrollment in enrollments %}
    <div class="card" style="border-left: 4px solid var(--primary); margin: 0; padding: var(--spacing-lg);">
        <h3 class="mb-2">{{ enrollment.course_name }}</h3>
        <p class="text-muted mb-3">{{ enrollment.description }}</p>

        <div class="grid grid-2 gap-2 mt-2 mb-3">
            <div>
                <p class="mb-2"><strong>ğŸ·ï¸ Batch:</strong> {{ enrollment.batch_name }}</p>
                <p class="mb-2"><strong>â° Schedule:</strong> {{ enrollment.schedule }}</p>
                <p class="mb-0"><strong>ğŸ• Timing:</strong> {{ enrollment.timing }}</p>
            </div>
            <div>
                <p class="mb-2"><strong>ğŸ‘¨â€ğŸ« Teacher:</strong> {{ enrollment.teacher_name or 'TBA' }}</p>
                <p class="mb-2"><strong>ğŸ“… Start:</strong> {{ enrollment.start_date }}</p>
                <div class="mb-2">
                    <span class="badge badge-{{ enrollment.status == 'active' and 'success' or 'secondary' }}">
                        {{ enrollment.status.upper() }}
                    </span>
                    <span class="badge badge-{{ enrollment.batch_status == 'ongoing' and 'primary' or 'info' }}">
                        {{ enrollment.batch_status.upper() }}
                    </span>
                    <!-- DEBUG: batch_status='{{ enrollment.batch_status }}', today='{{ today }}', start='{{ enrollment.start_date }}', end='{{ enrollment.end_date }}' -->
                </div>

                <div class="mb-2">
                    <span class="badge badge-{{ enrollment.completion_status == 'passed' and 'success' or 'info' }}">
                        {{ enrollment.completion_status }}
                    </span>
                </div>
                <p class="mb-0"><strong>ğŸ“… End:</strong> {{ enrollment.end_date or 'Ongoing' }}</p>
            </div>
        </div>

        <!-- Check-in Status or Button for ongoing batches -->
        {% if enrollment.batch_status == 'ongoing' and today >= enrollment.start_date|string and today <=
            enrollment.end_date|string %} <div class="mb-3">
            {% if enrollment.checkin_id %}
            <div class="alert alert-success" style="padding: 10px; margin: 0;">
                âœ“ Checked In for Today<br>
                <small>{{ enrollment.checkin_time.strftime('%I:%M %p') if enrollment.checkin_time else 'Today'
                    }}</small>
            </div>
            {% else %}
            <form method="POST" action="{{ url_for('student.checkin', batch_id=enrollment.batch_id) }}"
                style="margin: 0;">
                <button type="submit" class="btn btn-success btn-block">
                    ğŸ“ Check-in for Today's Class
                </button>
            </form>
            {% endif %}
    </div>
    {% endif %}

    <div class="d-flex gap-2">
        {% if enrollment.status == 'active' and enrollment.batch_status == 'ongoing' and (enrollment.payment_status ==
        'paid' or enrollment.access_granted) %}
        <a href="{{ url_for('student.materials') }}" class="btn btn-success btn-sm">
            ğŸ“š Start Learning
        </a>
        {% elif enrollment.status == 'active' and enrollment.batch_status != 'ongoing' %}
        <button class="btn btn-secondary btn-sm" disabled title="Batch not yet started or already completed">
            â¸ï¸ Not Available
        </button>
        {% elif enrollment.status == 'active' %}
        <button class="btn btn-secondary btn-sm" disabled title="Payment required or contact admin for access">
            ğŸ”’ Payment Required
        </button>
        {% endif %}
        <a href="{{ url_for('student.view_enrollment', enrollment_id=enrollment.enrollment_id) }}"
            class="btn btn-primary btn-sm">
            ğŸ‘ï¸ View Details
        </a>
        {% if enrollment.status == 'active' and enrollment.batch_status == 'upcoming' %}
        <form method="POST" action="{{ url_for('student.cancel_enrollment', enrollment_id=enrollment.enrollment_id) }}"
            style="display: inline-block;"
            onsubmit="return confirm('Are you sure you want to cancel this enrollment?');">
            <button type="submit" class="btn btn-danger btn-sm">
                âŒ Cancel
            </button>
        </form>
        {% elif enrollment.status == 'active' and enrollment.batch_status in ('ongoing', 'completed') %}
        <button type="button" class="btn btn-secondary btn-sm" disabled title="Cannot cancel ongoing/completed batch">
            âŒ Cancel (Not Allowed)
        </button>
        {% endif %}
    </div>
</div>
{% endfor %}
</div>
{% else %}
<div class="card text-center">
    <p class="text-muted mb-3">You are not enrolled in any courses yet.</p>
    <a href="{{ url_for('student.enroll') }}" class="btn btn-primary">Browse Available Courses</a>
</div>
{% endif %}
{% endblock %}